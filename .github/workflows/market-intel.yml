name: Market Intelligence Collection

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      seeds:
        description: 'Comma-separated seed queries (leave empty to use config file)'
        required: false
        type: string
      batch_size:
        description: 'Number of products to process per run'
        required: false
        default: '20'
        type: string
      skip_discovery:
        description: 'Skip SaaSHub discovery phase'
        required: false
        default: false
        type: boolean
      skip_homepages:
        description: 'Skip homepage discovery phase'
        required: false
        default: false
        type: boolean
      skip_extraction:
        description: 'Skip LLM extraction phase'
        required: false
        default: false
        type: boolean
      reset_state:
        description: 'Reset state and start fresh'
        required: false
        default: false
        type: boolean

  # Scheduled runs - daily at 2am UTC
  schedule:
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"
          # Install playwright browsers
          playwright install chromium

      - name: Download previous state
        uses: actions/download-artifact@v4
        with:
          name: market-intel-state
          path: data/
        continue-on-error: true  # First run won't have state

      - name: Download previous output
        uses: actions/download-artifact@v4
        with:
          name: market-intel-output
          path: data/
        continue-on-error: true  # First run won't have output

      - name: Reset state if requested
        if: ${{ github.event.inputs.reset_state == 'true' }}
        run: |
          rm -f data/market_intel_state.json
          echo "State reset completed"

      - name: Prepare seeds argument
        id: seeds
        run: |
          if [ -n "${{ github.event.inputs.seeds }}" ]; then
            # Convert comma-separated to space-separated
            SEEDS=$(echo "${{ github.event.inputs.seeds }}" | tr ',' ' ')
            echo "args=--seeds $SEEDS" >> $GITHUB_OUTPUT
          else
            echo "args=" >> $GITHUB_OUTPUT
          fi

      - name: Run market intelligence collection
        env:
          SAASHUB_API_KEY: ${{ secrets.SAASHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python -m crawl4ai.market_intel.collect \
            --verbose \
            --batch-size ${{ github.event.inputs.batch_size || '20' }} \
            --max-per-seed 30 \
            ${{ steps.seeds.outputs.args }} \
            ${{ github.event.inputs.skip_discovery == 'true' && '--skip-discovery' || '' }} \
            ${{ github.event.inputs.skip_homepages == 'true' && '--skip-homepages' || '' }} \
            ${{ github.event.inputs.skip_extraction == 'true' && '--skip-extraction' || '' }}

      - name: Upload state artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload even on failure
        with:
          name: market-intel-state
          path: data/market_intel_state.json
          retention-days: 90
          overwrite: true

      - name: Upload output artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: market-intel-output
          path: data/market_intel_products.jsonl
          retention-days: 90
          overwrite: true

      - name: Generate summary
        if: always()
        run: |
          echo "## Market Intelligence Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f data/market_intel_state.json ]; then
            echo "### State" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/market_intel_state.json | python -c "import sys,json; d=json.load(sys.stdin); print(json.dumps({k:v for k,v in d.items() if k not in ['products']}, indent=2))"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/market_intel_products.jsonl ]; then
            PRODUCT_COUNT=$(wc -l < data/market_intel_products.jsonl)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Output" >> $GITHUB_STEP_SUMMARY
            echo "- Total products in dataset: **$PRODUCT_COUNT**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Latest 5 Products" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            tail -5 data/market_intel_products.jsonl | python -c "import sys,json; [print(json.loads(line).get('product_info',{}).get('name','Unknown')) for line in sys.stdin]"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for halt condition
        if: always()
        run: |
          if [ -f data/market_intel_state.json ]; then
            HALTED=$(python -c "import json; print(json.load(open('data/market_intel_state.json')).get('halted', False))")
            if [ "$HALTED" = "True" ]; then
              echo "::warning::Collection was halted due to rate limits. Check state for details."
            fi
          fi
